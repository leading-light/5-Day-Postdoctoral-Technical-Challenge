# ==============================
# TASK 2: Medical Report Generation (Python 3.11 environment)
# ==============================

# 0️⃣ Install compatible transformers and dependencies in this environment
!pip install torch torchvision transformers==4.35.0 pillow matplotlib pandas

# 1️⃣ Imports
import torch
import pandas as pd
import numpy as np
from PIL import Image
from transformers import BlipProcessor, BlipForConditionalGeneration
import matplotlib.pyplot as plt
import os

device = "cpu"  # No GPU available

# 2️⃣ Load BLIP model (CPU-safe)
processor = BlipProcessor.from_pretrained("Salesforce/blip-image-captioning-base")
vlm_model = BlipForConditionalGeneration.from_pretrained(
    "Salesforce/blip-image-captioning-base"
).to(device)

# 3️⃣ Load Task 1 outputs
task1_dir = "task1_output"  # Shared folder or copy from Task 1 environment

test_predictions = pd.read_csv(os.path.join(task1_dir, "test_predictions.csv"))
misclassified_data = np.load(os.path.join(task1_dir, "misclassified_images.npz"))

# Load misclassified images for report generation
mis_images = misclassified_data["images"]  # shape: (N, 28,28)
mis_labels = misclassified_data["labels"]
mis_preds = misclassified_data["preds"]
mis_probs = misclassified_data["probs"]

# Convert misclassified images to PIL for BLIP
mis_pil_images = [Image.fromarray((img*255).astype(np.uint8)) for img in mis_images]

# 4️⃣ Generate reports for selected images
generated_reports = []

for idx, pil_img in enumerate(mis_pil_images):
    cnn_prob = mis_probs[idx]

    # CNN-conditioned prompt
    prompt = f"This chest X-ray has a predicted pneumonia probability of {cnn_prob:.2f}. Generate a structured radiology report with Findings and Impression."

    # Process image
    inputs = processor(images=pil_img, text=prompt, return_tensors="pt").to(device)

    # Generate report
    output_ids = vlm_model.generate(**inputs, max_length=200)
    report_text = processor.decode(output_ids[0], skip_special_tokens=True)

    generated_reports.append({
        "image_index": idx,
        "label": mis_labels[idx],
        "cnn_pred": mis_preds[idx],
        "cnn_prob": cnn_prob,
        "report": report_text
    })

# Save CSV
os.makedirs("task2_output", exist_ok=True)
df_reports = pd.DataFrame(generated_reports)
df_reports.to_csv("task2_output/generated_reports.csv", index=False)
print("Reports generated and saved to 'task2_output/generated_reports.csv'.")

# 5️⃣ Display sample
plt.figure(figsize=(12,4))
num_to_show = min(6, len(mis_pil_images))
for i in range(num_to_show):
    plt.subplot(1,num_to_show,i+1)
    plt.imshow(mis_pil_images[i], cmap="gray")
    plt.title(f"L:{mis_labels[i]} P:{mis_preds[i]}\nConf:{mis_probs[i]:.2f}")
    plt.axis("off")
plt.show()

# Print first 5 reports
for i, row in df_reports.head(5).iterrows():
    print(f"Image {row['image_index']}: Label={row['label']}, CNN Pred={row['cnn_pred']}, CNN Prob={row['cnn_prob']:.2f}")
    print("Report:")
    print(row['report'])
    print("-"*80)
